#!/bin/bash

# EC2 서버 정보
EC2_HOST="ubuntu@ec2-52-78-81-116.ap-northeast-2.compute.amazonaws.com"
PEM_FILE="/Users/ryansong/AWS_KEY/N3RVE_AWS.pem"

# Dropbox 토큰
DROPBOX_TOKEN="sl.u.AF24zrvkRICB3ipPOacFijyJx97nYg-_qArwFaHWBMSEIGYtyGt_HqfsgZgnMUu9oC8FDh_uXWmxmUJhk2VJrRraIAHhtcNl2S4IATODmtmMW6sMsXsbMJeVQ2HxpMlUcONXc22mLNE2-oCplDQYJJYdGU0wig4NiEFlfODp-x1y_WI1l3jAggHxvyfN-kvOn37Og2YC-RmWA8xWEtRloTZMzQZHgKOlIeAfAFOuSft947vBgIsDNimj5i9AluyVr1j3cS1bHi3llsGoRgk8stJQsXChTN3-mVzZE0tD07BwOj6eSll5UW5OUFX-LYsH3iuc205N0z5WlGX3nbuWiky7t6FiDTPUGv_kX364ifTfzlMloT90rS0RrBKhnqi_Mhd23B4b1Yaj5l8FpKJQIgXdT4pdHy6Rt9rL2xcgtZv-gL3foiI3CCO84ezcXrPoCpeUQhqEhpkuIfjbU_fT8oBUKKKkvyFyciFe7b6X4GFosyUCnMG5OVDkP8RQ6VYCvr0t67qoA0qpAnPI22PXIfDmrkNh3fEF9C-B7pc5vjK_Mi2FIksh9WLdPInC2Yk7I46s5NEE8rU5azeC5Mc0WeUHX81wx2I48R1dH_kx6AfiFNL4CF2I43qaEhjwsFU5k1RRqPyaYOH-sg-4zZMm3eHicHbdu4oIm69jljZhp8tDSeWDGaFx9hPdaDJRKN3Bq8ByfAAFFrMZlVnh5H7UGe7G1wZpaStvZhvafY8eajrlIrRGJCLF9GXYA7_Lg9ZJwDd0M5rCVEeyt5VWg99IF7R22yBpSYe7LcV1Y1mCg6lUnjjir-El5w8B_RUGOXhv5wUBP4zmb4WT8uvMem2dY8ZPeVpoQmFQ_GB0_qYIpXkgTI4216zhsji5mB0OpXJC2W4faa2PxhIFXAly9hEinujRHTZpc3EGc1Q4CnudvGFXdYArZ4YeMFovDZamkAiZnhPM7b-tEhX6xvXSiC9pah1jtryOmBEe7kOdl_6TNjBQG3Ihw_t2TzhMgR-__EIawk8TKuOlDD03w4zRjSrN4CZz2J8H1ytqWsWHuXH1n_UAqwqUDp0mvSIhqneBUIBLDtqXyfeP92ng4QhUkd7G6HSUfo4P5IGlGhSAXbuqeOAwIFdOnV9d0i66wtvNh6M4QQhgTjizNG3RHMMnnUuDLglF77whPXk7Ik5dC-tppdssI5Lz_Pq_SdEbISQ64bCSAyjKk6siCCVZGECRX6Jz-sfNGL1tIFpF6KuHJ3Nk9ZCpDsVAsV-adM38eoiUuiW9ESn6pBAl4ZuvPUxSpdM9qnVt"

echo "EC2 서버에 Dropbox 환경 변수 설정 중..."

# SSH 명령어로 원격 실행
ssh -i "$PEM_FILE" "$EC2_HOST" << 'ENDSSH'
cd /home/ubuntu/n3rve-onboarding-platform

# 기존 .env 파일 백업
if [ -f .env ]; then
    cp .env .env.backup
fi

# DROPBOX_ACCESS_TOKEN이 이미 있는지 확인
if grep -q "DROPBOX_ACCESS_TOKEN=" .env 2>/dev/null; then
    # 있으면 업데이트
    sed -i '/DROPBOX_ACCESS_TOKEN=/d' .env
fi

# 토큰 추가
echo "DROPBOX_ACCESS_TOKEN=sl.u.AF24zrvkRICB3ipPOacFijyJx97nYg-_qArwFaHWBMSEIGYtyGt_HqfsgZgnMUu9oC8FDh_uXWmxmUJhk2VJrRraIAHhtcNl2S4IATODmtmMW6sMsXsbMJeVQ2HxpMlUcONXc22mLNE2-oCplDQYJJYdGU0wig4NiEFlfODp-x1y_WI1l3jAggHxvyfN-kvOn37Og2YC-RmWA8xWEtRloTZMzQZHgKOlIeAfAFOuSft947vBgIsDNimj5i9AluyVr1j3cS1bHi3llsGoRgk8stJQsXChTN3-mVzZE0tD07BwOj6eSll5UW5OUFX-LYsH3iuc205N0z5WlGX3nbuWiky7t6FiDTPUGv_kX364ifTfzlMloT90rS0RrBKhnqi_Mhd23B4b1Yaj5l8FpKJQIgXdT4pdHy6Rt9rL2xcgtZv-gL3foiI3CCO84ezcXrPoCpeUQhqEhpkuIfjbU_fT8oBUKKKkvyFyciFe7b6X4GFosyUCnMG5OVDkP8RQ6VYCvr0t67qoA0qpAnPI22PXIfDmrkNh3fEF9C-B7pc5vjK_Mi2FIksh9WLdPInC2Yk7I46s5NEE8rU5azeC5Mc0WeUHX81wx2I48R1dH_kx6AfiFNL4CF2I43qaEhjwsFU5k1RRqPyaYOH-sg-4zZMm3eHicHbdu4oIm69jljZhp8tDSeWDGaFx9hPdaDJRKN3Bq8ByfAAFFrMZlVnh5H7UGe7G1wZpaStvZhvafY8eajrlIrRGJCLF9GXYA7_Lg9ZJwDd0M5rCVEeyt5VWg99IF7R22yBpSYe7LcV1Y1mCg6lUnjjir-El5w8B_RUGOXhv5wUBP4zmb4WT8uvMem2dY8ZPeVpoQmFQ_GB0_qYIpXkgTI4216zhsji5mB0OpXJC2W4faa2PxhIFXAly9hEinujRHTZpc3EGc1Q4CnudvGFXdYArZ4YeMFovDZamkAiZnhPM7b-tEhX6xvXSiC9pah1jtryOmBEe7kOdl_6TNjBQG3Ihw_t2TzhMgR-__EIawk8TKuOlDD03w4zRjSrN4CZz2J8H1ytqWsWHuXH1n_UAqwqUDp0mvSIhqneBUIBLDtqXyfeP92ng4QhUkd7G6HSUfo4P5IGlGhSAXbuqeOAwIFdOnV9d0i66wtvNh6M4QQhgTjizNG3RHMMnnUuDLglF77whPXk7Ik5dC-tppdssI5Lz_Pq_SdEbISQ64bCSAyjKk6siCCVZGECRX6Jz-sfNGL1tIFpF6KuHJ3Nk9ZCpDsVAsV-adM38eoiUuiW9ESn6pBAl4ZuvPUxSpdM9qnVt" >> .env

echo "환경 변수 설정 완료. Docker 재시작 중..."

# Docker 재시작
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d

echo "Docker 재시작 완료!"
echo "로그 확인 중..."
sleep 5
docker logs n3rve-app --tail 50
ENDSSH

echo "Dropbox 환경 변수 설정 완료!"